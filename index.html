<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TigerSoft Smart Office</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. VARIABLES & RESET --- */
        :root {
            --primary: #c9252c;
            --primary-hover: #a01b20;
            --bg-dark: #121212;
            --bg-panel: rgba(30, 30, 30, 0.6);
            --text-main: #ffffff;
            --text-muted: #888888;
            --sidebar-mini: 74px;
            --sidebar-full: 260px;
            --header-height: 70px;
        }

        /* Glassmorphism Util */
        .glass {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Roboto', sans-serif; background-color: var(--bg-dark); color: var(--text-main); overflow: hidden; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Utilities */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .pulse-dot { display: inline-block; width: 8px; height: 8px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 8px #00ff00; animation: pulse 2s infinite; }
        .text-glow { text-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* --- 2. LOADING SCREEN --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: #333; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .logo-loader { width: 100px; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); }
        .loading-bar { width: 200px; height: 4px; background: #ccc; margin-top: 30px; border-radius: 2px; overflow: hidden; position: relative; }
        .loading-fill { width: 50%; height: 100%; background: var(--primary); position: absolute; animation: slideLoading 1.5s infinite ease-in-out; }

        /* --- 3. LOGIN SCREEN --- */
        #login-screen {
            display: none; width: 100%; height: 100%;
            background: #222; opacity: 0; transition: opacity 0.5s;
        }
        .login-wrap { display: flex; width: 100%; height: 100%; }
        .login-left {
            width: 450px; background: #2c2c2c; display: flex; flex-direction: column;
            justify-content: center; align-items: center; position: relative; z-index: 2;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5); padding: 40px;
        }
        .login-right { flex: 1; position: relative; overflow: hidden; background: black; }
        .login-bg { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; filter: grayscale(30%); }
        
        .login-input { width: 100%; padding: 14px; background: #3f3f3f; border: 1px solid #555; color: white; border-radius: 4px; margin-bottom: 20px; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary); outline: none; background: #4a4a4a; }
        .btn-login { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 16px; }
        .btn-login:hover { background: var(--primary-hover); transform: translateY(-2px); }

        /* --- 4. DASHBOARD CONTAINER --- */
        #dashboard-screen { display: none; width: 100%; height: 100%; position: relative; }

        /* --- 5. SIDEBAR (MODERN HOVER EFFECT) --- */
        .sidebar {
            position: fixed; top: 0; left: 0; height: 100%;
            width: var(--sidebar-mini);
            background: var(--bg-panel);
            border-right: 1px solid #333;
            z-index: 2000;
            display: flex; flex-direction: column;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
            box-shadow: 4px 0 10px rgba(0,0,0,0.3);
        }
        .sidebar:hover { width: var(--sidebar-full); box-shadow: 10px 0 40px rgba(0,0,0,0.8); }

        /* Header Logo */
        .sidebar-head {
            height: var(--header-height); min-height: var(--header-height);
            display: flex; align-items: center; padding-left: 20px;
            border-bottom: 1px solid #333; background: var(--bg-panel);
            white-space: nowrap; overflow: hidden;
        }
        .logo-box { min-width: 35px; display: flex; justify-content: center; margin-right: 15px; }
        .logo-img { width: 35px; height: 35px; object-fit: contain; }
        .brand-text {
            font-family: 'Orbitron'; font-size: 16px; color: white; font-weight: bold;
            opacity: 0; transform: translateX(-10px); transition: all 0.3s ease;
        }
        .sidebar:hover .brand-text { opacity: 1; transform: translateX(0); transition-delay: 0.1s; }

        /* Menu Items */
        .menu-list { flex: 1; padding-top: 20px; overflow-y: auto; }
        .menu-item {
            height: 55px; display: flex; align-items: center; padding-left: 24px;
            color: #888; cursor: pointer; transition: 0.2s; white-space: nowrap; position: relative;
        }
        .menu-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .menu-item.active { color: white; background: linear-gradient(90deg, rgba(201,37,44,0.15) 0%, transparent 100%); border-right: 3px solid var(--primary); }
        .menu-item.active i { color: var(--primary); }
        
        .menu-item i { min-width: 25px; font-size: 20px; text-align: center; margin-right: 20px; transition: color 0.3s; }
        .menu-text { font-size: 14px; opacity: 0; transition: opacity 0.2s; }
        .sidebar:hover .menu-text { opacity: 1; transition-delay: 0.15s; }

        /* --- 6. MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-mini); /* Fix layout width */
            width: calc(100% - var(--sidebar-mini));
            height: 100%; background: var(--bg-dark);
            position: relative; display: flex; flex-direction: column;
            transition: margin-left 0.3s; /* Optional: remove if you want fixed */
        }

        /* Mobile Header */
        .mobile-header {
            display: none; height: 60px; background: var(--bg-panel);
            align-items: center; justify-content: space-between; padding: 0 20px;
            border-bottom: 1px solid #333; z-index: 1500;
        }
        .btn-hamburger { font-size: 24px; color: white; cursor: pointer; }

        /* Pages */
        .page-section { display: none; width: 100%; height: 100%; overflow-y: auto; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }

        /* --- 7. OVERVIEW LAYOUT (DIGITAL TWIN) --- */
        .overview-container { display: flex; height: 100%; position: relative; }
        
        /* 3D Visualization */
        .viz-area {
            flex: 1; background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
            display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;
        }
        .grid-floor {
            position: absolute; width: 200%; height: 200%;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px; transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridScroll 20s linear infinite;
        }
        .model-img { max-width: 80%; max-height: 70%; z-index: 10; animation: floatModel 6s ease-in-out infinite; filter: drop-shadow(0 30px 50px rgba(0,0,0,0.8)); }

        /* HUD Data Panel */
        .hud-panel {
            width: 400px; background: rgba(30,30,30,0.85); backdrop-filter: blur(15px);
            border-left: 1px solid #444; padding: 25px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; z-index: 20;
        }
        .hud-card { background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 8px; padding: 15px; }
        .hud-title { font-family: 'Orbitron'; font-size: 12px; color: #aaa; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* CO2 Gauge */
        .gauge-wrapper { width: 100%; height: 100px; position: relative; display: flex; justify-content: center; overflow: hidden; }
        .gauge-arc { width: 180px; height: 90px; background: conic-gradient(from 180deg at 50% 100%, #00ff00 0deg 60deg, #f1c40f 60deg 120deg, #ff0000 120deg 180deg); border-top-left-radius: 90px; border-top-right-radius: 90px; }
        .gauge-inner { position: absolute; bottom: 0; width: 140px; height: 70px; background: #222; border-top-left-radius: 70px; border-top-right-radius: 70px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px; }
        .gauge-needle { position: absolute; bottom: 0; left: 50%; width: 4px; height: 85px; background: white; transform-origin: bottom center; transform: rotate(-90deg); transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 2px; }

        /* --- 8. DESIGN PAGE --- */
        .design-toolbar { height: 60px; background: var(--bg-panel); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .design-body { height: calc(100% - 60px); display: flex; }
        .toolbox { width: 180px; background: #1a1a1a; border-right: 1px solid #333; padding: 15px; }
        .canvas { flex: 1; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; position: relative; overflow: hidden; }
        
        .node { width: 140px; background: #2c2c2c; border: 1px solid var(--primary); border-radius: 5px; margin-bottom: 10px; cursor: grab; position: relative; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .node.absolute { position: absolute; }
        .node-head { background: var(--primary); color: white; padding: 5px 10px; font-size: 11px; font-weight: bold; display: flex; justify-content: space-between; }
        .node-content { padding: 10px; font-size: 11px; color: #ccc; }

        /* --- 9. SETTINGS & OTHER --- */
        .settings-wrap { max-width: 800px; margin: 40px auto; padding: 20px; }
        .set-card { background: var(--bg-panel); border: 1px solid #333; border-radius: 8px; padding: 25px; margin-bottom: 20px; }
        .color-pick { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; display: inline-block; margin-right: 10px; }
        .color-pick.active { border-color: white; transform: scale(1.1); }
        .btn-action { background: #333; color: white; border: 1px solid #555; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-action:hover { background: #444; }

        /* --- 10. RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar { left: -100%; width: 260px; }
            .sidebar.show { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,1); }
            /* Force text show on mobile sidebar */
            .brand-text, .menu-text { opacity: 1; transform: none; }
            
            .main-content { margin-left: 0; width: 100%; }
            .mobile-header { display: flex; }
            
            .overview-container { flex-direction: column; overflow-y: auto; }
            .viz-area { min-height: 40vh; flex: none; border-bottom: 1px solid #333; }
            .hud-panel { width: 100%; flex: none; background: #121212; border-left: none; }
            
            .design-body { flex-direction: column; }
            .toolbox { width: 100%; height: 100px; display: flex; overflow-x: auto; border-right: none; border-bottom: 1px solid #333; }
            .node { min-width: 140px; margin-right: 10px; }
        }

        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes slideLoading { 0% { left: -50%; width: 30%; } 50% { width: 60%; } 100% { left: 100%; width: 30%; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes floatModel { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes gridScroll { from { background-position: 0 0; } to { background-position: 0 40px; } }
        /* --- 12. AI ALERTS --- */
        #ai-alert-banner {
            position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
            width: 60%; background: rgba(255, 0, 0, 0.9); backdrop-filter: blur(10px);
            border: 1px solid #ff5555; border-radius: 0 0 10px 10px;
            padding: 15px 30px; z-index: 3000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 50px rgba(255,0,0,0.5);
            transition: top 0.5s ease-in-out;
        }
        #ai-alert-banner.show { top: 0; }
        .alert-pulse {
            width: 10px; height: 10px; background: white; border-radius: 50%;
            animation: alertPulse 0.5s infinite;
        }
        @keyframes alertPulse { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(3); } }

    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="logo-loader">
            <img src="image (1).png" style="width:100%;">
        </div>
        <div class="loading-bar">
            <div class="loading-fill"></div>
        </div>
        <div style="margin-top: 15px; font-weight: bold; color: #555;">INITIALIZING AI SYSTEM...</div>
    </div>

    <div id="login-screen">
        <div class="login-wrap">
            <div class="login-left">
                <img src="image (1).png" style="width:80px; margin-bottom: 20px;">
                <h1 style="color:white; font-family:'Orbitron'; margin:0;">TIGER SOFT</h1>
                <p style="color:#888; margin-bottom:40px;">Smart Office Platform</p>
                
                <div style="width:100%;">
                    <label style="color:#aaa; font-size:12px; margin-bottom:5px; display:block;">USERNAME</label>
                    <input type="text" class="login-input" value="admin">
                    <label style="color:#aaa; font-size:12px; margin-bottom:5px; display:block;">PASSWORD</label>
                    <input type="password" class="login-input" value="12345678">
                    <button class="btn-login" id="btn-login">LOGIN</button>
                </div>
            </div>
            <div class="login-right">
                <img src="image (1).png" class="login-bg">
                <div style="position:absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to right, #2c2c2c, transparent);"></div>
            </div>
        </div>
    </div>

    <div id="ai-alert-banner">
        <div style="display:flex; align-items:center; gap:20px;">
            <div class="alert-pulse"></div>
            <div>
                <div style="font-weight:bold; font-size:18px; color:white;">AI DETECTED ANOMALY</div>
                <div id="ai-msg" style="font-size:12px; color:black;">Abnormal power surge in Zone B</div>
            </div>
        </div>
        <button onclick="resolveAlarm()" style="background:white; color:red; border:none; padding:8px 20px; font-weight:bold; cursor:pointer; border-radius:20px;">RESOLVE</button>
    </div>

    <div id="dashboard-screen">
        
        <header class="mobile-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="image (1).png" style="width:30px;">
                <span style="font-weight:bold; font-family:'Orbitron';">TigerSoft</span>
            </div>
            <i class="fas fa-bars btn-hamburger" onclick="toggleSidebar()"></i>
        </header>

        <nav class="sidebar" id="sidebar">
            <div class="sidebar-head">
                <div class="logo-box">
                    <img src="image (1).png" class="logo-img">
                </div>
                <div class="brand-text">TigerSoft<br>Smart Office</div>
            </div>

            <div class="menu-list">
                <div class="menu-item active" onclick="navTo('overview', this)">
                    <i class="fas fa-chart-pie"></i> <span class="menu-text">Overview</span>
                </div>
                <div class="menu-item" onclick="navTo('design', this)">
                    <i class="fas fa-pencil-ruler"></i> <span class="menu-text">System Design</span>
                </div>
                <div class="menu-item" onclick="navTo('hvac', this)">
                    <i class="fas fa-fan"></i> <span class="menu-text">HVAC Control</span>
                </div>
                <div class="menu-item" onclick="navTo('energy', this)">
                    <i class="fas fa-bolt"></i> <span class="menu-text">Energy Logs</span>
                </div>
                <div class="menu-item" onclick="navTo('settings', this)">
                    <i class="fas fa-cog"></i> <span class="menu-text">Settings</span>
                </div>
            </div>

            <div style="margin-top: auto; padding-bottom: 20px; border-top: 1px solid #333;">
                <div class="menu-item" style="color: #ff5555;" onclick="location.reload()">
                    <i class="fas fa-sign-out-alt"></i> <span class="menu-text">Logout</span>
                </div>
            </div>
        </nav>

        <main class="main-content" onclick="closeSidebarMobile()">
            
            <section id="page-overview" class="page-section active">
                <div class="overview-container">
                    <div class="viz-area">
                        <div class="grid-floor"></div>
                        <div style="position: absolute; top: 20px; left: 20px; font-size: 10px; color: rgba(255,255,255,0.5);">
                            LIVE RENDER: BUILDING A<br>STATUS: ONLINE
                        </div>
                        <img src="Gemini_Generated_Image_u80ab9u80ab9u80a-Photoroom.png" class="model-img">
                    </div>

                    <div class="hud-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--primary); padding-bottom: 10px;">
                            <span style="font-family:'Orbitron'; font-size:18px;">FACILITY STATUS</span>
                            <span class="pulse-dot"></span>
                        </div>

                        <div class="hud-card" style="border-left: 3px solid var(--primary);">
                            <div class="hud-title"><i class="fas fa-magic"></i> AI Energy Prediction (Month)</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div>
                                    <div style="font-size: 28px; font-weight: bold; font-family:'Orbitron'; color:var(--primary);">4,250 <span style="font-size:14px;">kWh</span></div>
                                    <div style="font-size:11px; color:#aaa; margin-top:5px;">Forecasted for Dec 2025</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 14px; color:#00ff00; font-weight:bold;"><i class="fas fa-arrow-down"></i> 5.2%</div>
                                    <div style="font-size: 10px; color:#888;">vs Last Month</div>
                                </div>
                            </div>
                            <div style="width:100%; background:#333; height:4px; margin-top:10px; border-radius:2px;">
                                <div style="width:75%; background:var(--primary); height:100%; border-radius:2px; box-shadow:0 0 10px var(--primary);"></div>
                            </div>
                        </div>

                        <div class="hud-card">
                            <div class="hud-title"><i class="fas fa-cloud-sun"></i> Environment (Bangkok)</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div>
                                    <div style="font-size: 32px; font-weight: bold; font-family:'Orbitron';">32°C</div>
                                    <div style="color:#888; font-size:12px;">Outdoor Temp</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: bold;">65%</div>
                                    <div style="color:#888; font-size:12px;">Humidity</div>
                                </div>
                            </div>
                        </div>

                        <div class="hud-card">
                            <div class="hud-title"><i class="fas fa-lungs"></i> Air Quality (CO2)</div>
                            <div class="gauge-wrapper">
                                <div class="gauge-arc"></div>
                                <div class="gauge-inner">
                                    <div style="text-align: center;">
                                        <div id="co2-val" style="font-family:'Orbitron'; font-size:24px; font-weight:bold;">650</div>
                                        <div style="font-size:10px; color:#aaa;">PPM</div>
                                    </div>
                                </div>
                                <div class="gauge-needle" id="co2-needle"></div>
                            </div>
                        </div>

                        <div class="hud-card">
                            <div class="hud-title"><i class="fas fa-chart-line"></i> Power Consumption (kW)</div>
                            <div style="height: 120px; width: 100%;">
                                <canvas id="overviewChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-design" class="page-section">
                <div class="design-toolbar glass">
                    <div style="font-weight:bold; color:white;"><i class="fas fa-layer-group"></i> Layout Designer (Floor 2)</div>
                    <div>
                         <button id="btn-link" class="btn-action" onclick="toggleLinkMode()"><i class="fas fa-bezier-curve"></i> Connect Cable</button>
                         <button class="btn-action" style="background:var(--primary); border:none;" onclick="saveSystem()"><i class="fas fa-save"></i> Save System</button>
                    </div>
                </div>
                <div class="design-body">
                    <div class="toolbox glass">
                        <div style="color:#666; font-size:10px; font-weight:bold; margin-bottom:15px;">COMPONENTS</div>
                        <div class="node" draggable="true" ondragstart="dragStart(event, 'new', 'ac', 'Zone A')">
                            <div class="node-head">AC Unit (Zone A) <i class="fas fa-wind"></i></div>
                        </div>
                        <div class="node" draggable="true" ondragstart="dragStart(event, 'new', 'ac', 'Zone B')">
                            <div class="node-head">AC Unit (Zone B) <i class="fas fa-wind"></i></div>
                        </div>
                        <div class="node" draggable="true" ondragstart="dragStart(event, 'new', 'meter', 'Main')">
                            <div class="node-head" style="background:#e67e22">Power Meter <i class="fas fa-bolt"></i></div>
                        </div>
                        <div style="margin-top:20px; font-size:10px; color:#555;">Drag items to canvas</div>
                    </div>
                    <div class="canvas" id="canvas-area" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <svg id="connections-layer" style="position:absolute; inset:0; pointer-events:none; width:100%; height:100%; z-index:0;"></svg>
                        <div class="node absolute" id="node-gw" style="top:50px; left:50px;" draggable="true" ondragstart="dragStart(event, 'move')" onclick="nodeClick(this)">
                            <div class="node-head" style="background:#333;">IoT Gateway <i class="fas fa-server"></i></div>
                            <div class="node-content">IP: 192.168.1.1<br>Status: Master</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-hvac" class="page-section">
                <div style="padding:30px;">
                    <h2 style="font-family:'Orbitron'; border-bottom:1px solid #333; padding-bottom:15px;">HVAC Control Panel</h2>
                    <div id="hvac-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top:20px;">
                        <div style="grid-column:1/-1; text-align:center; color:#666; padding:50px;">Please design the system first.</div>
                    </div>
                </div>
            </section>

            <section id="page-energy" class="page-section">
                <div style="padding:30px; display:flex; flex-direction:column; height:100%;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h2 style="font-family:'Orbitron'; margin:0;">Energy Analytics</h2>
                        <div>
                            <button class="btn-action" onclick="updateEnergy('hourly')">Hourly</button>
                            <button class="btn-action" onclick="updateEnergy('daily')">Daily</button>
                        </div>
                    </div>
                    <div style="background:var(--bg-panel); border:1px solid #333; border-radius:8px; padding:20px; height:300px; margin-bottom:20px;">
                        <canvas id="energyChart"></canvas>
                    </div>
                    <h3 style="margin-bottom:10px;">Device Breakdown (Live Status)</h3>
                    <div id="device-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;"></div>
                </div>
            </section>

            <section id="page-settings" class="page-section">
                <div class="settings-wrap">
                    <h2 style="font-family:'Orbitron'; border-bottom:2px solid var(--primary); padding-bottom:10px; margin-bottom:30px;">System Settings</h2>
                    
                    <div class="set-card glass">
                        <h3><i class="fas fa-palette"></i> Interface Theme</h3>
                        <p style="color:#888; font-size:13px; margin-bottom:15px;">Choose the primary accent color for the dashboard.</p>
                        <div>
                            <div class="color-pick active" style="background:#c9252c;" onclick="setTheme('#c9252c', this)"></div>
                            <div class="color-pick" style="background:#007bff;" onclick="setTheme('#007bff', this)"></div>
                            <div class="color-pick" style="background:#28a745;" onclick="setTheme('#28a745', this)"></div>
                            <div class="color-pick" style="background:#e67e22;" onclick="setTheme('#e67e22', this)"></div>
                        </div>
                    </div>

                    <div class="set-card">
                        <h3><i class="fas fa-flask"></i> Simulation Tools</h3>
                        <p style="color:#888; font-size:13px;">Tools for testing system response.</p>
                        <button class="btn-action" onclick="triggerAlarm()"><i class="fas fa-fire"></i> Trigger Fire Alarm</button>
                        <button class="btn-action" onclick="alert('Network Reset Request Sent.')"><i class="fas fa-wifi"></i> Restart Gateway</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- STATE VARIABLES ---
        let systemNodes = [];
        let systemWires = [];
        let isLinking = false; 
        let linkStart = null;
        let chartOverview, chartEnergy;
        let currentColor = '#c9252c';

        // --- 1. INITIALIZATION ---
        window.addEventListener('load', () => {
             // Restore System
             const saved = localStorage.getItem('tiger_sys_v4');
             if(saved) {
                 try {
                     const data = JSON.parse(saved);
                     systemWires = data.wires || [];
                     const nodes = data.nodes || [];
                     // We need to rebuild DOM for nodes if they aren't there?? 
                     // User removed restoreCanvas(). I must re-add it.
                     restoreCanvas(nodes);
                 } catch(e) {}
             }
            
            // Fake loading sequence
            setTimeout(() => {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('login-screen').style.display = 'block';
                    setTimeout(() => document.getElementById('login-screen').style.opacity = '1', 50);
                }, 500);
            }, 1500);
        });

        document.getElementById('btn-login').addEventListener('click', () => {
            const btn = document.getElementById('btn-login');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ACCESSING...';
            
            setTimeout(() => {
                document.getElementById('login-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('dashboard-screen').style.display = 'block';
                    initSystem();
                }, 500);
            }, 1000);
        });

        function initSystem() {
            initCharts();
            startSimulation();
            renderDeviceList(); // Initial Render
        }

        // --- 2. NAVIGATION ---
        function navTo(pageId, el) {
            // Sidebar UI
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            el.classList.add('active');

            // Page Switching
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');

            // Close Mobile Sidebar
            closeSidebarMobile();

            // Specific page refresh
            if(pageId === 'hvac') renderHVAC();
            if(pageId === 'energy') renderDeviceList();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        function closeSidebarMobile() {
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }

        // --- 3. CHARTS ---
        function initCharts() {
            // Overview Line Chart
            const ctx1 = document.getElementById('overviewChart').getContext('2d');
            const grad = ctx1.createLinearGradient(0,0,0,150);
            grad.addColorStop(0, hexToRgba(currentColor, 0.5));
            grad.addColorStop(1, 'rgba(0,0,0,0)');

            chartOverview = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['10:00','10:10','10:20','10:30','10:40','10:50'],
                    datasets: [{
                        data: [50, 55, 60, 58, 62, 65],
                        borderColor: currentColor,
                        backgroundColor: grad,
                        fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });

            // Energy Bar Chart
            const ctx2 = document.getElementById('energyChart').getContext('2d');
            chartEnergy = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
                    datasets: [{
                        label: 'kWh',
                        data: [120, 150, 180, 140, 160, 90, 80],
                        backgroundColor: currentColor,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#ccc' } } },
                    scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } }
                }
            });
        }

        function updateEnergy(type) {
            if(type === 'hourly') {
                chartEnergy.data.labels = ['8am','9am','10am','11am','12pm'];
                chartEnergy.data.datasets[0].data = [10,15,22,25,30];
            } else {
                chartEnergy.data.labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                chartEnergy.data.datasets[0].data = [120, 150, 180, 140, 160, 90, 80];
            }
            chartEnergy.update();
        }

        // --- 4. DRAG & DROP DESIGN ---
        function allowDrop(ev) { ev.preventDefault(); }
        
        function dragStart(ev, mode, type, zone) {
            ev.dataTransfer.setData("mode", mode);
            ev.dataTransfer.setData("type", type);
            ev.dataTransfer.setData("zone", zone);
            if(mode === 'move') {
                ev.dataTransfer.setData("id", ev.target.id);
                const rect = ev.target.getBoundingClientRect();
                ev.dataTransfer.setData("offX", ev.clientX - rect.left);
                ev.dataTransfer.setData("offY", ev.clientY - rect.top);
            }
        }

        function drop(ev) {
            ev.preventDefault();
            const mode = ev.dataTransfer.getData("mode");
            const canvas = document.getElementById('canvas-area');
            const rect = canvas.getBoundingClientRect();
            const x = ev.clientX - rect.left;
            const y = ev.clientY - rect.top;

            if(mode === 'new') {
                const type = ev.dataTransfer.getData("type");
                const zone = ev.dataTransfer.getData("zone");
                const id = 'node-' + Date.now();
                
                const el = document.createElement('div');
                el.className = 'node absolute';
                el.id = id;
                el.draggable = true;
                el.style.left = (x - 70) + 'px';
                el.style.top = (y - 20) + 'px';
                el.dataset.type = type;
                el.dataset.zone = zone;
                el.ondragstart = (e) => dragStart(e, 'move');
                
                let icon = type === 'ac' ? '<i class="fas fa-wind"></i>' : '<i class="fas fa-bolt"></i>';
                let headColor = type === 'ac' ? currentColor : '#e67e22';

                el.innerHTML = `
                    <div class="node-head" style="background:${headColor}">${type.toUpperCase()} ${zone} ${icon}</div>
                    <div class="node-content">ID: ${id.substr(-5)}<br>Status: OK</div>
                `;
                el.onclick = function() { nodeClick(this) }; // Click to wire
                el.oncontextmenu = (e) => { e.preventDefault(); deleteNode(id); }; // Right click delete
                canvas.appendChild(el);
            } else if(mode === 'move') {
                const id = ev.dataTransfer.getData("id");
                const offX = ev.dataTransfer.getData("offX");
                const offY = ev.dataTransfer.getData("offY");
                const el = document.getElementById(id);
                el.style.left = (x - offX) + 'px';
                el.style.top = (y - offY) + 'px';
                renderWires(); // Update lines
            }
        }

        function deleteNode(id) {
             if(confirm("Delete this node?")) {
                 document.getElementById(id).remove();
                 systemWires = systemWires.filter(w => w.from !== id && w.to !== id); // Remove wires
                 renderWires();
                 saveSystem(); // Auto save
             }
        }

        /* --- 5. WIRING & HYBRID SAVE --- */
        function toggleLinkMode() {
            isLinking = !isLinking;
            const btn = document.getElementById('btn-link');
            if(isLinking) {
                btn.classList.add('active'); 
                btn.style.background = '#e67e22';
                btn.innerHTML = "Select Source Node...";
            } else {
                btn.classList.remove('active');
                btn.style.background = '#333';
                btn.innerHTML = '<i class="fas fa-bezier-curve"></i> Connect Cable';
                linkStart = null;
                document.querySelectorAll('.node').forEach(n => n.style.boxShadow = '');
            }
        }

        function nodeClick(el) {
            if(!isLinking) return;
            if(!linkStart) {
                linkStart = el.id;
                el.style.boxShadow = '0 0 15px white';
                document.getElementById('btn-link').innerHTML = "Select Target Node...";
            } else {
                if(linkStart !== el.id) {
                    systemWires.push({from: linkStart, to: el.id});
                    renderWires();
                    saveSystem();
                }
                toggleLinkMode(); 
            }
        }

        function renderWires() {
            const svg = document.getElementById('connections-layer');
            svg.innerHTML = '';
            const cRect = document.getElementById('canvas-area').getBoundingClientRect();

            systemWires.forEach(w => {
                const e1 = document.getElementById(w.from);
                const e2 = document.getElementById(w.to);
                if(!e1 || !e2) return;
                
                const r1 = e1.getBoundingClientRect();
                const r2 = e2.getBoundingClientRect();

                const x1 = (r1.left - cRect.left) + r1.width/2;
                const y1 = (r1.top - cRect.top) + r1.height/2;
                const x2 = (r2.left - cRect.left) + r2.width/2;
                const y2 = (r2.top - cRect.top) + r2.height/2;

                const line = document.createElementNS('http://www.w3.org/2000/svg','line');
                line.setAttribute('x1', x1); line.setAttribute('y1', y1);
                line.setAttribute('x2', x2); line.setAttribute('y2', y2);
                line.setAttribute('stroke', '#fff');
                line.setAttribute('stroke-width', '2');
                line.setAttribute('stroke-opacity', '0.5');
                line.setAttribute('stroke-dasharray', '5,5');
                svg.appendChild(line);
            });
        }

        function saveSystem() {
            systemNodes = [];
            // Read from DOM to get current positions
            document.querySelectorAll('.node.absolute').forEach(n => {
                if(n.id !== 'node-gw') {
                    systemNodes.push({ id: n.id, type: n.dataset.type, zone: n.dataset.zone, x: parseInt(n.style.left), y: parseInt(n.style.top) });
                }
            });
            // Save nodes AND wires
            const data = { nodes: systemNodes, wires: systemWires };
            localStorage.setItem('tiger_sys_v4', JSON.stringify(data));
            
            // alert(`Saved! Wires: ${systemWires.length}`);
            renderHVAC();
            renderDeviceList();
        }

        // Restore wires on load (Nodes are restored by user's logic? No, user logic doesn't have restore function!)
        // Wait, user removed restore logic in init. I need to add it back to init.


        // --- 5. RENDER CONTENT ---
        function renderHVAC() {
            const container = document.getElementById('hvac-container');
            container.innerHTML = '';
            
            if(systemNodes.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666;">No devices found. Go to Design tab.</div>';
                return;
            }

            // Group devices
            const zones = {};
            systemNodes.forEach(d => {
                if(d.type === 'ac') {
                    if(!zones[d.zone]) zones[d.zone] = [];
                    zones[d.zone].push(d);
                }
            });

            for(const [zone, devs] of Object.entries(zones)) {
                let html = `
                    <div style="background:var(--bg-panel); padding:20px; border-radius:8px; border:1px solid #333;">
                        <h4 style="margin-top:0; color:${currentColor}; border-bottom:1px solid #444; padding-bottom:10px;">${zone}</h4>
                `;
                devs.forEach((d, i) => {
                    // Random CO2 and Power for HVAC view
                    const randCO2 = Math.floor(Math.random() * (800 - 400) + 400);
                    const randPower = (Math.random() * 2 + 0.5).toFixed(2);
                    
                    html += `
                        <div style="background:#252525; padding:15px; border-radius:4px; margin-bottom:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <div style="font-weight:bold; font-size:14px;">Unit ${i+1}</div>
                                <i class="fas fa-power-off" style="color:#00ff00; cursor:pointer;" onclick="this.style.color = this.style.color === 'rgb(0, 255, 0)' ? '#555' : '#00ff00'"></i>
                            </div>
                            
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:11px; color:#aaa;">
                                <div style="background:#333; padding:5px; border-radius:3px;">
                                    <div>Temp</div>
                                    <div style="color:white; font-weight:bold;">24°C</div>
                                </div>
                                <div style="background:#333; padding:5px; border-radius:3px;">
                                    <div>Room CO2</div>
                                    <div style="color:white; font-weight:bold;">${randCO2} ppm</div>
                                </div>
                                <div style="background:#333; padding:5px; border-radius:3px; grid-column:1/-1;">
                                    <div>Power Usage (Real-time)</div>
                                    <div style="color:${currentColor}; font-weight:bold;">${randPower} kW</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML += html;
            }
        }

        function renderDeviceList() {
            const container = document.getElementById('device-list');
            if(!container) return; // Guard clause
            
            container.innerHTML = '';
            
            let data = systemNodes.length > 0 ? systemNodes : [{type:'ac', zone:'Demo A'}, {type:'ac', zone:'Demo B'}, {type:'ac', zone:'Demo C'}];
            
            data.forEach((d, i) => {
                // Random Active Power Logic
                const load = (Math.random() * 3).toFixed(2);
                
                container.innerHTML += `
                    <div style="background:var(--bg-panel); padding:15px; border-radius:6px; border-left:3px solid ${currentColor}; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold; font-size:13px;">${d.type.toUpperCase()}-${i+1}</div>
                            <div style="font-size:11px; color:#888;">${d.zone}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-family:'Orbitron'; font-size:16px; color:white;">${load}</div>
                            <div style="font-size:10px; color:#666;">kWh</div>
                        </div>
                    </div>
                `;
            });
        }

        // --- 6. SIMULATION & SETTINGS ---
        function startSimulation() {
            // CO2 Needle
            setInterval(() => {
                const val = 400 + Math.floor(Math.random() * 400);
                const deg = ((val - 400) / 1000) * 180 - 90;
                document.getElementById('co2-needle').style.transform = `rotate(${deg}deg)`;
                document.getElementById('co2-val').innerText = val;
            }, 3000);

            // Chart Update
            setInterval(() => {
                const newVal = 50 + Math.floor(Math.random() * 20);
                const ds = chartOverview.data.datasets[0].data;
                ds.shift();
                ds.push(newVal);
                chartOverview.update();
            }, 2000);

            // Energy List Live Update
            setInterval(() => {
                // Only update if Energy Page is active to save resources
                if(document.getElementById('page-energy').classList.contains('active')) {
                    renderDeviceList();
                }
                if(document.getElementById('page-energy').classList.contains('active')) {
                    renderDeviceList();
                }
            }, 3000);
            
            // AI Anomaly
            setInterval(checkAI, 10000);
        }

        function checkAI() {
            if(Math.random() > 0.7) {
                 const issues = [
                    { t: "HIGH TEMP", m: "Server Room exceeding 28°C", c: "#ff5555" },
                    { t: "POWER SURGE", m: "Voltage spike detected in Zone A", c: "#e67e22" },
                    { t: "AIR QUALITY", m: "CO2 Levels Critical in Hallway", c: "#9b59b6" }
                ];
                const issue = issues[Math.floor(Math.random() * issues.length)];
                document.getElementById('ai-msg').innerText = issue.m;
                const banner = document.getElementById('ai-alert-banner');
                banner.style.borderTopColor = issue.c;
                banner.classList.add('show');
            }
        }

        function resolveAlarm() {
            document.getElementById('ai-alert-banner').classList.remove('show');
        }

        function restoreCanvas(nodes) {
             const canvas = document.getElementById('canvas-area');
             systemNodes = nodes; // Sync state
             
             nodes.forEach(n => {
                 if(document.getElementById(n.id)) return; 
                 
                 const el = document.createElement('div');
                 el.className = 'node absolute';
                 el.id = n.id;
                 el.draggable = true;
                 el.style.left = (n.x || 50) + 'px';
                 el.style.top = (n.y || 50) + 'px';
                 el.dataset.type = n.type;
                 el.dataset.zone = n.zone;
                 el.ondragstart = (e) => dragStart(e, 'move');
                 el.onclick = function() { nodeClick(this) };
                 el.oncontextmenu = (e) => { e.preventDefault(); deleteNode(n.id); };
                 
                 let icon = n.type === 'ac' ? '<i class="fas fa-wind"></i>' : '<i class="fas fa-bolt"></i>';
                 let headColor = n.type === 'ac' ? currentColor : '#e67e22';

                 el.innerHTML = `
                    <div class="node-head" style="background:${headColor}">${n.type.toUpperCase()} ${n.zone} ${icon}</div>
                    <div class="node-content">ID: ${n.id.substr(-5)}<br>Status: OK</div>
                 `;
                 canvas.appendChild(el);
             });
             setTimeout(renderWires, 100);
             setTimeout(renderHVAC, 200); // Initial render of HVAC
        }

        function setTheme(color, el) {
            currentColor = color;
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--primary-hover', color);
            
            document.querySelectorAll('.color-pick').forEach(c => c.classList.remove('active'));
            el.classList.add('active');

            // Update Chart Colors
            if(chartOverview) {
                chartOverview.data.datasets[0].borderColor = color;
                const ctx = document.getElementById('overviewChart').getContext('2d');
                const grad = ctx.createLinearGradient(0,0,0,150);
                grad.addColorStop(0, hexToRgba(color, 0.5));
                grad.addColorStop(1, 'rgba(0,0,0,0)');
                chartOverview.data.datasets[0].backgroundColor = grad;
                chartOverview.update();
            }
            if(chartEnergy) {
                chartEnergy.data.datasets[0].backgroundColor = color;
                chartEnergy.update();
            }
            // Update Node Headers
            document.querySelectorAll('.node-head').forEach(n => {
                if(n.innerText.includes('AC')) n.style.background = color;
            });
            // Re-render lists to apply color
            renderDeviceList();
            renderHVAC();
        }

        function triggerAlarm() {
            document.body.style.animation = 'pulse 0.5s infinite';
            document.documentElement.style.setProperty('--primary', '#ff0000');
            alert('FIRE ALARM ACTIVATED! EVACUATE.');
            setTimeout(() => {
                document.body.style.animation = 'none';
            }, 5000);
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            return `rgba(${r},${g},${b},${alpha})`;
        }

    </script>
</body>
</html>